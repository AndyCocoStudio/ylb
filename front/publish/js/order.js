!function(){var e={hideaddress:!1,id:$.urlParam("id")||"",count:$.urlParam("count")||1,useb:0,total:0,postage:0,ispoint:"disabled",maxpoint:0,point:0,product:{},address:{},select:{},showlist:!1,plist:[],clist:[],alist:[],userpoint:0,newaddress:{name:"",mobile:"",province:"",provinceCode:"",city:"",cityCode:"",area:"",areaCode:"",street:"",postCode:"",isDefault:1}},t={init:function(){t.getAddress(),t.getPlist(),t.getUserPoint(),$.checkFlag()},getUserPoint:function(){$.when($.ajax({url:$.apiUrl+"/user/asset",type:"GET"})).done(function(t){$.ylbAjaxHandler(t,function(){e.userpoint=t.data.score})})},getPlist:function(){$.when($.ajax({url:$.apiUrl+"/address",type:"GET"})).done(function(t){$.ylbAjaxHandler(t,function(){e.plist=t.data})})},getClist:function(t){$.when($.ajax({url:$.apiUrl+"/address?code="+t,type:"GET"})).done(function(t){$.ylbAjaxHandler(t,function(){e.clist=t.data})})},getAlist:function(t){$.when($.ajax({url:$.apiUrl+"/address?code="+t,type:"GET"})).done(function(t){$.ylbAjaxHandler(t,function(){e.alist=t.data})})},getAddress:function(){$.when($.ajax({url:$.apiUrl+"/user/addresses",type:"GET"})).done(function(a){$.ylbAjaxHandler(a,function(){e.address=a.data,e.defaultaddress=a.data[0],t.getProduct()})})},updateAddress:function(){$.ajax({url:$.apiUrl+"/user/addresses",type:"GET"}).done(function(t){$.ylbAjaxHandler(t,function(){e.address=t.data,e.defaultaddress=t.data[0],e.hideaddress=!1})})},getProduct:function(){if(e.id)$.when($.ajax({url:$.apiUrl+"/goods/detail",type:"GET",data:{id:e.id}})).done(function(a){$.ylbAjaxHandler(a,function(){e.product=a.data,e.product.goodses[0].count=e.count,e.postage=a.data.goodses[0].freight,t.countPrice(),t.buildVue()})});else{var a=$.parseHandler("sj",$.localStorageHandler("get","shopcart"));e.product.goodses=a,t.countPrice(),t.buildVue()}},countPrice:function(){for(var t=0,a=0,d=0;d<e.product.goodses.length;d++){var n=e.product.goodses[d];t+=n.price*n.count,a+=n.deduction*n.count}e.total=t.toFixed(2),e.maxpoint=a},buildVue:function(){e=new Vue({el:"#order-main",data:e,methods:{choseaddress:function(t){e.select.addressID=t.target.attributes["data-id"].value},showaddress:function(){e.hideaddress=!e.hideaddress},alladdress:function(){e.showlist=!e.showlist},changeprov:function(a){var d=$(a.target),n=d.val(),o=d.find("option:selected").text();e.newaddress.provinceCode=n,e.newaddress.province=o,e.alist=[],t.getClist(n)},changecity:function(a){var d=$(a.target),n=d.val(),o=d.find("option:selected").text();e.newaddress.cityCode=n,e.newaddress.city=o,t.getAlist(n)},changearea:function(t){var a=$(t.target),d=a.val(),n=a.find("option:selected").text();e.newaddress.areaCode=d,e.newaddress.area=n},addcount:function(a){var d=$(a.target).attr("data-index");e.product.goodses[d].count=+e.product.goodses[d].count,e.product.goodses[d].count+=1,t.countPrice()},reducecount:function(a){var d=$(a.target).attr("data-index");e.product.goodses[d].count=+e.product.goodses[d].count,e.product.goodses[d].count-1>0&&(e.product.goodses[d].count-=1),t.countPrice()},canuse:function(){"disabled"==e.ispoint?e.ispoint=!1:e.ispoint="disabled"},usepoint:function(){var t;t=e.userpoint>e.maxpoint?e.maxpoint:e.userpoint,e.point>t&&(e.point=t)},addaddress:function(){$.ajax({url:$.apiUrl+"/user/address",type:"PUT",data:JSON.stringify(e.newaddress)}).done(function(e){$.ylbAjaxHandler(e,function(){$.ylbAlert("添加成功！"),t.updateAddress()})})},deleteadr:function(e){var a=confirm("确认要删除该地址?");if(a){var d=e.target.attributes["data-id"].value;$.ajax({url:$.apiUrl+"/user/address?id="+d,type:"DELETE"}).done(function(e){$.ylbAjaxHandler(e,function(){$.ylbAlert("删除成功！"),t.updateAddress()})})}},usebalance:function(t){$(t.target).is(":checked")?e.useb=1:e.useb=0},neworder:function(){if(!e.select.addressID)return void $.ylbAlert("请选择收货地址");for(var t={},a="",d=[],n=0;n<e.product.goodses.length;n++){var o=e.product.goodses[n],s={goodsID:o.goodsID,quantity:o.count,note:o.remark};d.push(s)}t.items=d,t.score=e.point,t.addressID=e.select.addressID,t.isUseBalance=e.useb,$.ajax({url:$.apiUrl+"/order/shoppingonline",type:"PUT",data:JSON.stringify(t)}).done(function(t){$.ylbAjaxHandler(t,function(){a=t.data,e.id||$.localStorageHandler("clear","shopcart"),window.location.href="pay.html?oid="+a})})}}})}};t.init()}();