!function(){var t={hideaddress:!1,id:$.urlParam("id")||"",count:$.urlParam("count")||"",total:0,postage:0,ispoint:"disabled",maxpoint:0,point:0,product:{},address:{},select:{},note:"无",showlist:!1,plist:[],clist:[],alist:[],newaddress:{name:"",mobile:"",province:"",provinceCode:"",city:"",cityCode:"",area:"",areaCode:"",street:"",postCode:"",isDefault:1}},e={init:function(){e.getAddress(),e.getPlist()},getPlist:function(){$.when($.ajax({url:$.apiUrl+"/address",type:"GET"})).done(function(e){$.ylbAjaxHandler(e,function(){t.plist=e.data})})},getClist:function(e){$.when($.ajax({url:$.apiUrl+"/address?code="+e,type:"GET"})).done(function(e){$.ylbAjaxHandler(e,function(){t.clist=e.data})})},getAlist:function(e){$.when($.ajax({url:$.apiUrl+"/address?code="+e,type:"GET"})).done(function(e){$.ylbAjaxHandler(e,function(){t.alist=e.data})})},getAddress:function(){$.when($.ajax({url:$.apiUrl+"/user/addresses",type:"GET"})).done(function(d){$.ylbAjaxHandler(d,function(){t.address=d.data,t.defaultaddress=d.data[0],e.getProduct()})})},updateAddress:function(){$.ajax({url:$.apiUrl+"/user/addresses",type:"GET"}).done(function(e){$.ylbAjaxHandler(e,function(){t.address=e.data})})},getProduct:function(){t.id&&$.when($.ajax({url:$.apiUrl+"/goods/detail",type:"GET",data:{id:t.id}})).done(function(d){$.ylbAjaxHandler(d,function(){t.product=d.data,t.product.goodses[0].count=t.count,e.countPrice(),e.buildVue()})})},countPrice:function(){for(var e=0,d=0,n=0;n<t.product.goodses.length;n++){var a=t.product.goodses[n];e+=a.price*a.count,d+=a.deduction*a.count}t.total=e.toFixed(2),t.maxpoint=d},buildVue:function(){t=new Vue({el:"#order-main",data:t,methods:{choseaddress:function(e){t.select.addressID=e.target.attributes["data-id"].value},showaddress:function(){t.hideaddress=!t.hideaddress},alladdress:function(){t.showlist=!t.showlist},changeprov:function(d){var n=$(d.target),a=n.val(),o=n.find("option:selected").text();t.newaddress.provinceCode=a,t.newaddress.province=o,t.alist=[],e.getClist(a)},changecity:function(d){var n=$(d.target),a=n.val(),o=n.find("option:selected").text();t.newaddress.cityCode=a,t.newaddress.city=o,e.getAlist(a)},changearea:function(e){var d=$(e.target),n=d.val(),a=d.find("option:selected").text();t.newaddress.areaCode=n,t.newaddress.area=a},addcount:function(d){var n=$(d.target).attr("data-index");t.product.goodses[n].count=+t.product.goodses[n].count,t.product.goodses[n].count+=1,e.countPrice()},reducecount:function(d){var n=$(d.target).attr("data-index");t.product.goodses[n].count=+t.product.goodses[n].count,t.product.goodses[n].count-1>0&&(t.product.goodses[n].count-=1),e.countPrice()},canuse:function(){"disabled"==t.ispoint?t.ispoint=!1:t.ispoint="disabled"},usepoint:function(){t.point>t.maxpoint&&(t.point=t.maxpoint)},addaddress:function(){$.ajax({url:$.apiUrl+"/user/address",type:"PUT",data:JSON.stringify(t.newaddress)}).done(function(t){$.ylbAjaxHandler(t,function(){$.ylbAlert("添加成功！"),e.updateAddress()})})},deleteadr:function(t){var d=t.target.attributes["data-id"].value;alert(d),$.ajax({url:$.apiUrl+"/user/address",type:"DELETE",data:JSON.stringify({id:d})}).done(function(t){$.ylbAjaxHandler(t,function(){$.ylbAlert("删除成功！"),e.updateAddress()})})},neworder:function(){for(var e={},d="",n="",a=0;a<t.product.goodses.length;a++){var o=t.product.goodses[a];n+="{goodsID:"+o.goodsID+",quantity:"+o.count+",note:"+t.note+"},"}n="["+n.substring(0,n.length-1)+"]",e.items=n,e.score=t.point,e.addressID=t.select.addressID,$.ajax({url:$.apiUrl+"/order/shoppingonline",type:"PUT",data:JSON.stringify(e)}).done(function(t){$.ylbAjaxHandler(t,function(){d=t.data})})}}})}};e.init()}();